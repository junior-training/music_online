KISSY.add(function(t,e,s,n,a,r,o,l){function c(t){var e=this;this.el=d(t),this.audio=this.el.one("audio")[0],this.volume=.5,this.animImg=d(".rotate-img"),this.pageIndex={chinese:0,western:0,jk:0,rank:0},this.hintIndex=-1,this.musicData={},this.mList=[],this.lrc=[],this.defaltImg="resource/img/default.jpg",this.currentPlay=0,this.animStyle={transform:"rotate(360deg)"},this.animCfg={duration:15,easing:"easeNone",complete:function(){e.animImg.css("transform","rotate(0deg)"),e.animCD=new s(e.animImg,e.animStyle,e.animCfg),e.animCD.run()}},this.animCD=new s(this.animImg,this.animStyle,this.animCfg),this.typeListenTimes=0}var d=t.all;return c.prototype.init=function(){var t,e,s=this;this.musicList(),0===this.mList.length?(t="",e=this.defaltImg):(d(d(".p-info a")[0]).text(this.mList[this.currentPlay].title),d(d(".p-info a")[1]).text(this.mList[this.currentPlay].artist),d(d(".p-info a")[2]).text(this.mList[this.currentPlay].album),t=this.mList[this.currentPlay].src,e=this.mList[this.currentPlay].img),d(this.audio).attr("src",t),this.searchHandler(),this.initPanel(),this.animImg.css("background-image",'url("'+e+'")'),d(".m-list .list-item:nth-child("+(this.currentPlay+1)+")").addClass("playing");var i=d(".show-list"),n=d(".show-type"),o=d(".music-list"),l=!1,c=d(".type-wrap"),h=!1,u=d(".gutter"),p=d(".time-info");i.on("click",function(){l?(o.css("transform","translate3d(-300px,0,0)"),d(this).css({width:"40px",border:"none"}).text(">"),l=!1):(o.css("transform","translate3d(300px,0,0)"),d(this).css({width:"200px",border:"1px solid"}).text("< 正在播放"),l=!0)}),n.on("click",function(){h?(c.css("transform","translate3d(300px, 0, 0)"),d(".volume").css("right","100px"),d(this).css({width:"40px",border:"none"}).text("<"),h=!1):(c.css("transform","translate3d(-300px, 0, 0)"),d(".volume").css("right","300px"),d(this).css({width:"200px",border:"1px solid"}).text("到处看看 >"),h=!0)}),d(s.audio).on("timeupdate",this.handleTimeUpdate(s)),u.on("mouseenter",function(t){0!==s.audio.currentTime&&(p.css({top:t.pageY+10,left:t.pageX+10,display:"block"}),u.on("mousemove",function(t){p.css({top:t.pageY+10,left:t.pageX+10}),t.halt()}))}),u.on("mouseleave",function(){p.css({display:"none"}),u.detach("mousemove")}),u.on("click",function(t){void 0!==s.audio.currentTime&&(s.audio.currentTime=Math.floor(t.pageX/d(this).width()*1e3+3)/1e3*Math.floor(s.audio.duration))}),this.handleDetail(),new a({type:"get",url:"displayTop10Songs",success:function(t){s.musicData=t,s.initTeyeWrap(t)},error:function(t){console.log(t)},dataType:"json"}),this.handleVol(),this.makeLrc(),new r.Draggable({node:".handler"}),new r.Draggable({node:".vol-handler"}),r.DDM.on("drag",function(t){var e=d(t.drag.userConfig.node);if(e.hasClass("handler")&&e.css("left",t.pageX-15),e.hasClass("vol-handler")){var s=t.pageY-e.parent().offset().top-5;0>s&&(s=0),s>100&&(s=100),e.css("top",s)}})},c.prototype.handleTimeUpdate=function(t){return function(){var e=d(".handler"),s=0,i=(d(".gutter"),d(".time-info"),2),n=Math.floor(this.currentTime/60),a=Math.floor(this.currentTime%60),r=Math.floor(this.duration/60),o=Math.floor(this.duration%60);if(s=this.currentTime/this.duration*100,e.css("left",s-1+"%"),this.ended&&t.playOther(t.currentPlay+1),d(".time-info").text(n+":"+a+"/"+r+":"+o),!(0===t.lrc.length||this.currentTime<t.lrc[2].timeline)){for(;!(this.currentTime>=t.lrc[i].timeline&&this.currentTime<t.lrc[i+1].timeline);)if(i++,i>=t.lrc.length-1)return;d(".lrc-text").css({transform:"translate3D(0, "+-18*(i-1)+"px, 0)"})}}},c.prototype.initPanel=function(){var t=this,e=d(".toggle"),s=d(".otherBtn"),i=d(".forward"),n=d(".backward"),a=d(".next"),r=d(".pre");e.on("click",function(){if(t.audio.paused){if(0===t.mList.length)return;t.audio.play(),t.animCD.isPaused()?t.animCD.resume():t.animCD.run(),d(this).css("background-position","-264px -3px")}else t.audio.pause(),t.animCD.pause(),d(this).css("background-position","-34px -44px")}),e.on("mouseenter",function(){d(this).siblings().addClass("p-show")}),s.on("mouseleave",function(){d(this).removeClass("p-show")}),i.on("click",function(){t.audio.currentTime+=5}),n.on("click",function(){t.audio.currentTime-=5}),a.on("click",function(){t.playOther(t.currentPlay+1)}),r.on("click",function(){t.playOther(t.currentPlay-1)})},c.prototype.handleVol=function(){var t=this,e=d(".volume"),s=d(".volIcon"),i=d(".volBar"),n=d(".barWrap"),a=d(".vol-handler");s.on("mouseenter",function(t){n.css("transform","rotateX(0)"),t.halt()}),e.on("mouseleave",function(t){n.css("transform","rotateX(90deg)"),t.halt()}),s.on("click",function(e){d(this).toggleClass("mute"),0===t.audio.volume?(t.audio.volume=t.volume,a.css("top",100-100*t.volume-1+"%")):(t.audio.volume=0,a.css("top","99%")),e.halt()}),i.on("click",function(e){a.css("top",e.pageY-i.offset().top-5+"px");var n=(a.offset().top-i.offset().top)/100;0>n?n=0:n>1&&(n=1),t.audio.volume=t.volume=1-n,0===t.audio.volume?s.addClass("mute"):s.removeClass("mute")})},c.prototype.getPlaylist=function(){var t=[];return t=JSON.parse(localStorage.getItem("playlist")),t||[]},c.prototype.musicList=function(){this.mList=this.getPlaylist();for(var t=d(".m-list"),e=[],s=this,i=0;i<this.mList.length;i++)e.push(new n(o).render(this.mList[i]));var a=e.join("\n");t.append(a),t.delegate("click",".m-list .list-item",function(t){s.playOther(d(t.currentTarget).index()),d(".toggle").css("background-position","-264px -3px"),t.halt()}),t.delegate("click",".m-operate .m-delete",function(t){var e=d(t.currentTarget).parent().parent(),i=e.index();s.mList.splice(i,1),localStorage.setItem("playlist",JSON.stringify(s.mList)),e.remove(),i<s.currentPlay?s.currentPlay--:i===s.currentPlay&&s.playOther(i),0===s.mList.length&&(s.animCD.pause(),d(".toggle").css("background-position","-34px -44px")),t.halt()}),t.delegate("click",".m-operate .m-download",function(t){s.logDownload(d(t.currentTarget).parent().parent().index()),t.stopPropagation()})},c.prototype.playOther=function(t){var e=this,s=d(".handler"),i=0;if(0===this.mList.length)return this.animImg.css("background-image","url(resource/img/default.jpg)"),s.css("left",i-1+"%"),this.audio.remove(),this.audio=d("<audio></audio>")[0],void this.el.append(this.audio);t>=this.mList.length&&(t=0),0>t&&(t=this.mList.length-1),d(".m-list .list-item:nth-child("+(this.currentPlay+1)+")").removeClass("playing"),this.currentPlay=t,d(".m-list .list-item:nth-child("+(this.currentPlay+1)+")").addClass("playing"),this.audio.remove(),this.audio=d('<audio src="'+this.mList[this.currentPlay].src+'"></audio>')[0],this.el.append(this.audio),d(this.audio).on("timeupdate",this.handleTimeUpdate(e)),d(this.audio).on("progress",function(){}),this.audio.play(),d(".volIcon").hasClass("mute")&&(this.audio.volume=0),d(d(".p-info a")[0]).text(this.mList[this.currentPlay].title),d(d(".p-info a")[1]).text(this.mList[this.currentPlay].artist),d(d(".p-info a")[2]).text(this.mList[this.currentPlay].album),this.animCD.isPaused()&&this.animCD.resume(),this.animCD.isRunning()||this.animCD.run(),this.animImg.css("background-image",'url("'+this.mList[this.currentPlay].img+'")'),this.makeLrc();var n=this.mList[this.currentPlay].id;new a({type:"post",url:"sendListeningHistory",data:{id:n,type:"listen"},error:function(t){console.log(t)}})},c.prototype.mkTypeList=function(t){for(var e=d(".t-"+t+" .t-list"),s=this,i=[],a=this.musicData[t],r="",o=0;o<a.length;o++)i.push(new n(l).render(a[o]));r=i.join("\n"),e.append(r),this.typeListenTimes>=4||(e.delegate("click",".t-list .add-plist",function(e){var i=d(e.currentTarget);s.addToPlaylist(t,i.parent().parent().index()),e.halt()}),e.delegate("click",".t-list .play-now",function(e){var i=d(e.currentTarget);s.addToPlaylist(t,i.parent().parent().index()),s.playOther(s.mList.length-1),d(".toggle").css("background-position","-264px -3px"),e.halt()}),e.delegate("click",".t-list .download",function(e){s.logDownload(d(e.currentTarget).parent().parent().index(),t)}),this.typeListenTimes++)},c.prototype.logDownload=function(t,e){var s;2===arguments.length?s=this.musicData[e][t].id:1===arguments.length&&(s=this.mList[t].id),new a({type:"post",url:"updateListeningHistory",data:{id:s,type:"download"},error:function(t){console.log(t)}})},c.prototype.initTeyeWrap=function(){function t(t,s){new a({type:"get",url:"displayMoreSongs",data:{type:t,index:s},success:function(i){var n=d(".t-"+t+" .prePage"),a=d(".t-"+t+" .nextPage");d(".t-"+t+" .t-list li").remove(),e.musicData[t]=i,e.mkTypeList(t),d(".t-"+t+" .t-list").hasClass("fade-in")?(d(".t-"+t+" .t-list").removeClass("fade-in"),d(".t-"+t+" .t-list").addClass("fade-in2")):(d(".t-"+t+" .t-list").removeClass("fade-in2"),d(".t-"+t+" .t-list").addClass("fade-in")),n.css("display","block"),1===s?n.addClass("disable"):s>1&&n.removeClass("disable"),e.musicData[t].length<15?a.css("display","block").addClass("disable"):a.css("display","block").removeClass("disable")},error:function(t){console.log(t)},dataType:"json"})}var e=this,s=d(".type-nav"),n=s.all("a"),r=(d(".t-section"),d(".t-section>li")),o=1,l=!1,c=0;this.mkTypeList("chinese"),this.mkTypeList("western"),this.mkTypeList("jk"),this.mkTypeList("rank"),d(r[o-1]).css({opacity:1,"z-index":150}),i=1,n.each(function(){this[0].index=i++}),d(n[o-1]).addClass("currentTab"),s.on("click",function(t){var e=t.target.parentElement.index||t.target.index;if(!l&&o!==e){var s={transform:"translateX(100%) scale(0.9)",opacity:0,"z-index":100},i={transform:"translateX(0)","z-index":150,opacity:1},a={duration:1,easing:"cubic-bezier(0.7, 0, 0.3, 1)",complete:function(){--c,0===c&&(l=!1,o=e)},useTransiton:!0},h={duration:1,easing:"cubic-bezier(0.7, 0, 0.3, 1)",complete:function(){o=e,--c,0===c&&(l=!1,o=e)},useTransiton:!0};e&&!l&&(d(n[o-1]).removeClass("currentTab"),d(n[e-1]).addClass("currentTab"),d(r[o-1]).animate(s,a),++c,d(r[e-1]).css({transform:"translateX(-100%)"}).animate(i,h),++c,l=!0)}}),d(".t-chinese .more").on("click",this.handlerMore("chinese")),d(".t-western .more").on("click",this.handlerMore("western")),d(".t-jk .more").on("click",this.handlerMore("jk")),d(".t-rank .more").on("click",this.handlerMore("rank")),d(".t-section").delegate("click",".prePage",function(s){var i=d(s.currentTarget).parent(),n=i.hasClass("t-chinese")?"chinese":i.hasClass("t-western")?"western":i.hasClass("t-jk")?"jk":i.hasClass("t-rank")?"rank":void 0;return void 0!==n?0===--e.pageIndex[n]?void(e.pageIndex[n]=1):void t(n,e.pageIndex[n]):void 0}),d(".t-section").delegate("click",".nextPage",function(s){var i=d(s.currentTarget).parent(),n=i.hasClass("t-chinese")?"chinese":i.hasClass("t-western")?"western":i.hasClass("t-jk")?"jk":i.hasClass("t-rank")?"rank":void 0;if(void 0!==n){var a=d(".t-"+n+" .nextPage");a.hasClass("disable")||t(n,++e.pageIndex[n])}})},c.prototype.handlerMore=function(t){var e=this;return this.pageIndex[t]=1,function(){new a({type:"get",url:"displayMoreSongs",data:{type:t,index:"1"},success:function(s){d(".t-"+t+" .t-list li").remove(),e.musicData[t]=s,e.mkTypeList(t),d(".t-"+t+" .prePage").css("display","block").addClass("disable"),e.musicData[t].length<15?d(".t-"+t+" .nextPage").css("display","block").addClass("disable"):d(".t-"+t+" .nextPage").css("display","block"),d(".t-"+t+" .t-list").addClass("fade-in")},error:function(t){console.log(t)},dataType:"json"})}},c.prototype.makeLrc=function(){var t=this,e=this.mList[this.currentPlay].id;new a({type:"get",url:"getLyric",data:{id:e},dataType:"json",success:function(e){0===e.length&&(d(".lyric").css("display","none"),d(".default-info").css("display","block"));var s="";t.lrc=e;for(var i=0;i<t.lrc.length;i++)s+='<p class="line" data-index = "'+i+'">'+t.lrc[i].text+"</p>";d(".lyric .lrc-text p").remove(),d(".lyric .lrc-text").append(s),d(".lyric").css("display","block"),d(".default-info").css("display","none")},error:function(){d(".lyric").css("display","none"),d(".default-info").css("display","block")}})},c.prototype.addToPlaylist=function(t,e){var s=this.musicData[t][e];this.mList.push(s),localStorage.setItem("playlist",JSON.stringify(this.mList)),d(".music-list .m-list").append(new n(o).render(s))},c.prototype.searchHandler=function(){function t(){var t=s.val();""!==t&&new a({type:"get",url:"accurateSearch",data:{searchKey:t},success:function(t){for(var e="",s=0,i=t.length;i>s;s++)e+=new n(l).render(t[s]);d(".search-result>ul li").remove(),d(".search-result>ul").append(e),searchResult=t,c.css("display","none"),d(".search-result").css("display","block"),d(".detail-info").css({transform:"rotateX(0)","z-index":200}),d(".p-panel").css("z-index",0)},error:function(t){console.log(t)},dataType:"json"})}var e=d(".search-bar"),s=d(".search-bar>input"),i=d(".search-bar>button"),r=d(".search-hint"),c=d(".text-body"),h=this;s.on("focusin",function(){e.css("box-shadow","0 0 6px")}),s.on("focusout",function(){e.css("box-shadow","none"),r.css("visibility","hidden")}),s.on("valuechange",function(t){var e=t.newVal;d(".search-hint ul li").remove(),""!==e&&new a({type:"get",url:"fuzzySearch",data:{searchKey:e},success:function(t){var e="",s=0;if(0!==t["歌曲"].length||0!==t["歌手"].length||0!==t["专辑"].length){for(var i=0;i<t["歌曲"].length&&!(s>=5);i++)e+='<li class = "hint-item"><span class = "s-info">'+t["歌曲"][i].songName+'</span><span class = "s-type">歌曲</span></li>',s++;for(var i=0;i<t["歌手"].length&&!(s>=5);i++)e+='<li class = "hint-item"><span class = "s-info">'+t["歌手"][i].singerName+'</span><span class = "s-type">歌手</span></li>',s++;for(var i=0;i<t["专辑"].length&&!(s>=5);i++)e+='<li class = "hint-item"><span class = "s-info">'+t["专辑"][i].albumName+'</span><span class = "s-type">专辑</span></li>',s++;d(".search-hint ul").append(e),d(".search-hint").css("visibility","visible")}},error:function(t){console.log(t)},dataType:"json"})}),d(".search-result>ul").delegate("click",".search-result .add-plist",function(t){var e=d(t.currentTarget);h.mList.push(searchResult[e.parent().parent().index()]),localStorage.setItem("playlist",JSON.stringify(h.mList)),d(".music-list .m-list").append(new n(o).render(searchResult[e.parent().parent().index()])),t.halt()}),d(".search-result>ul").delegate("click",".search-result .play-now",function(t){var e=d(t.currentTarget);h.mList.push(searchResult[e.parent().parent().index()]),localStorage.setItem("playlist",JSON.stringify(h.mList)),d(".music-list .m-list").append(new n(o).render(searchResult[e.parent().parent().index()])),h.playOther(h.mList.length-1),d(".toggle").css("background-position","-264px -3px"),t.halt()}),s.on("keydown",function(e){var s=d(".search-hint ul li");switch(e.keyCode){case 13:0!==d(".search-hint .selected").length&&d(".search input").val(d(s[h.hintIndex]).one(".s-info").text()),t(),e.halt();break;case 38:if(e.halt(),0===s.length)return;d(s[h.hintIndex]).removeClass("selected"),--h.hintIndex<0&&(h.hintIndex=s.length-1),d(s[h.hintIndex]).addClass("selected");break;case 40:if(e.halt(),0===s.length)return;d(s[h.hintIndex]).removeClass("selected"),++h.hintIndex>=s.length&&(h.hintIndex=0),d(s[h.hintIndex]).addClass("selected")}}),i.on("click",t)},c.prototype.handleDetail=function(){var t=d(".detail-info");d(".close").on("click",function(){t.css({transform:"rotateX(90deg)","z-index":0}),d(".p-panel").css("z-index",100)})},c},{requires:["node","anim","xtemplate","io","dd","player/tpl/mListItem-xtpl","player/tpl/tListItem-xtpl"]});